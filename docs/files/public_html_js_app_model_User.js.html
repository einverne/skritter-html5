<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>public_html\js\app\model\User.js - Skritter HTML5: Documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Skritter HTML5: Documentation"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.50</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Api.html">Api</a></li>
            
                <li><a href="../classes/Application.html">Application</a></li>
            
                <li><a href="../classes/Assets.html">Assets</a></li>
            
                <li><a href="../classes/CanvasCharacter.html">CanvasCharacter</a></li>
            
                <li><a href="../classes/CanvasStroke.html">CanvasStroke</a></li>
            
                <li><a href="../classes/Facade.html">Facade</a></li>
            
                <li><a href="../classes/Functions.html">Functions</a></li>
            
                <li><a href="../classes/HomeView.html">HomeView</a></li>
            
                <li><a href="../classes/IndexedDBAdapter.html">IndexedDBAdapter</a></li>
            
                <li><a href="../classes/InfoView.html">InfoView</a></li>
            
                <li><a href="../classes/LeapController.html">LeapController</a></li>
            
                <li><a href="../classes/Log.html">Log</a></li>
            
                <li><a href="../classes/LoginView.html">LoginView</a></li>
            
                <li><a href="../classes/LogItem.html">LogItem</a></li>
            
                <li><a href="../classes/Mauler.html">Mauler</a></li>
            
                <li><a href="../classes/OptionsView.html">OptionsView</a></li>
            
                <li><a href="../classes/PinyinConverter.html">PinyinConverter</a></li>
            
                <li><a href="../classes/Prompt.html">Prompt</a></li>
            
                <li><a href="../classes/PromptCanvas.html">PromptCanvas</a></li>
            
                <li><a href="../classes/PromptDefn.html">PromptDefn</a></li>
            
                <li><a href="../classes/PromptRdng.html">PromptRdng</a></li>
            
                <li><a href="../classes/PromptRune.html">PromptRune</a></li>
            
                <li><a href="../classes/PromptTone.html">PromptTone</a></li>
            
                <li><a href="../classes/Recognizer.html">Recognizer</a></li>
            
                <li><a href="../classes/Router.html">Router</a></li>
            
                <li><a href="../classes/Scheduler.html">Scheduler</a></li>
            
                <li><a href="../classes/Settings.html">Settings</a></li>
            
                <li><a href="../classes/Shortstraw.html">Shortstraw</a></li>
            
                <li><a href="../classes/Storage.html">Storage</a></li>
            
                <li><a href="../classes/StrokeMap.html">StrokeMap</a></li>
            
                <li><a href="../classes/StudyDecomp.html">StudyDecomp</a></li>
            
                <li><a href="../classes/StudyDecomps.html">StudyDecomps</a></li>
            
                <li><a href="../classes/StudyItem.html">StudyItem</a></li>
            
                <li><a href="../classes/StudyItems.html">StudyItems</a></li>
            
                <li><a href="../classes/StudyParam.html">StudyParam</a></li>
            
                <li><a href="../classes/StudyParams.html">StudyParams</a></li>
            
                <li><a href="../classes/StudyReview.html">StudyReview</a></li>
            
                <li><a href="../classes/StudyReviews.html">StudyReviews</a></li>
            
                <li><a href="../classes/StudySentence.html">StudySentence</a></li>
            
                <li><a href="../classes/StudySentences.html">StudySentences</a></li>
            
                <li><a href="../classes/StudySRSConfigs.html">StudySRSConfigs</a></li>
            
                <li><a href="../classes/StudyStroke.html">StudyStroke</a></li>
            
                <li><a href="../classes/StudyStrokes.html">StudyStrokes</a></li>
            
                <li><a href="../classes/StudyView.html">StudyView</a></li>
            
                <li><a href="../classes/StudyVocab.html">StudyVocab</a></li>
            
                <li><a href="../classes/StudyVocabs.html">StudyVocabs</a></li>
            
                <li><a href="../classes/Timer.html">Timer</a></li>
            
                <li><a href="../classes/User.html">User</a></li>
            
                <li><a href="../classes/VocabView.html">VocabView</a></li>
            
                <li><a href="../classes/Words.html">Words</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Collection.html">Collection</a></li>
            
                <li><a href="../modules/Component.html">Component</a></li>
            
                <li><a href="../modules/Facade.html">Facade</a></li>
            
                <li><a href="../modules/Model.html">Model</a></li>
            
                <li><a href="../modules/Prompt.html">Prompt</a></li>
            
                <li><a href="../modules/Skritter.html">Skritter</a></li>
            
                <li><a href="../modules/Storage.html">Storage</a></li>
            
                <li><a href="../modules/View.html">View</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: public_html\js\app\model\User.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @module Skritter
 * @submodule Model
 * @param Log
 * @param StudyDecomps
 * @param StudyItems
 * @param StudyParams
 * @param StudyReviews
 * @param StudySRSConfigs
 * @param StudySentences
 * @param StudyStrokes
 * @param StudyVocabs
 * @author Joshua McFarland
 */
define([
    &#x27;collection/Log&#x27;,
    &#x27;collection/StudyDecomps&#x27;,
    &#x27;collection/StudyItems&#x27;,
    &#x27;collection/StudyParams&#x27;,
    &#x27;collection/StudyReviews&#x27;,
    &#x27;collection/StudySRSConfigs&#x27;,
    &#x27;collection/StudySentences&#x27;,
    &#x27;collection/StudyStrokes&#x27;,
    &#x27;collection/StudyVocabs&#x27;,
    &#x27;backbone&#x27;
], function(Log, StudyDecomps, StudyItems, StudyParams, StudyReviews, StudySRSConfigs, StudySentences, StudyStrokes, StudyVocabs) {
    /**
     * @class User
     */
    var User = Backbone.Model.extend({
        initialize: function() {
            Skritter.log = new Log();
            Skritter.study = {
                decomps: new StudyDecomps(),
                items: new StudyItems(),
                params: new StudyParams(),
                reviews: new StudyReviews(),
                srsconfigs: new StudySRSConfigs(),
                sentences: new StudySentences(),
                strokes: new StudyStrokes(),
                vocabs: new StudyVocabs()
            };
            if (localStorage.getItem(&#x27;activeUser&#x27;)) {
                this.set(JSON.parse(localStorage.getItem(localStorage.getItem(&#x27;activeUser&#x27;))));
            }
            this.on(&#x27;change&#x27;, this.cache);
        },
        /**
         * @property {Object} defaults
         */
        defaults: {
            access_token: null,
            audio: true,
            expires_in: null,
            isSyncing: false,
            lastLogin: null,
            lastReviewFix: null,
            lastSync: null,
            refresh_token: null,
            settings: null,
            token_type: null,
            user_id: null
        },
        /**
         * @method cache
         */
        cache: function() {
            if (this.isLoggedIn()) {
                localStorage.setItem(this.get(&#x27;user_id&#x27;), JSON.stringify(this));
            }
        },
        /**
         * Quickly caches all of the users current loaded data to storage and returns a callback.
         * 
         * @method cacheAllData
         * @param {Function} callback
         */
        cacheAllData: function(callback) {
            Skritter.async.parallel([
                /*function(callback) {
                    Skritter.log.cache(function() {
                        callback();
                    });
                },*/
                function(callback) {
                    Skritter.study.decomps.cache(function() {
                        callback();
                    });
                },
                function(callback) {
                    Skritter.study.items.cache(function() {
                        callback();
                    });
                },
                function(callback) {
                    Skritter.study.reviews.cache(function() {
                        callback();
                    });
                },
                function(callback) {
                    Skritter.study.srsconfigs.cache(function() {
                        callback();
                    });
                },
                function(callback) {
                    Skritter.study.sentences.cache(function() {
                        callback();
                    });
                },
                function(callback) {
                    Skritter.study.strokes.cache(function() {
                        callback();
                    });
                },
                function(callback) {
                    Skritter.study.vocabs.cache(function() {
                        callback();
                    });
                }
            ], function() {
                callback();
            });
        },
        /**
         * @method checkReviewErrors
         * @param {Function} callback
         * @param {Boolean} fixErrors
         */
        checkReviewErrors: function(callback, fixErrors) {
            Skritter.api.getReviewErrors(this.get(&#x27;lastReviewFix&#x27;), _.bind(function(errors) {
                if (errors.length &gt; 0) {
                    console.log(&#x27;Review Errors&#x27;, errors);
                    if (fixErrors) {
                        this.fixReviewErrors(errors, function(items) {
                            callback(errors, items);
                        });
                    } else {
                        callback(errors);
                    }
                } else {
                    callback(errors);
                }
            }, this));
        },
        /**
         * Gets the current active users properties and settings from the server then saves it.
         * 
         * @method fetch
         * @param {Function} callback
         */
        fetch: function(callback) {
            if (this.isLoggedIn()) {
                Skritter.api.getUser(this.get(&#x27;user_id&#x27;), _.bind(function(data) {
                    this.set(&#x27;settings&#x27;, data);
                    callback(data);
                }, this));
            }
        },
        fixReviewErrors: function(errors, callback) {
            var errorIds = [];
            for (var i in errors) {
                errorIds.push(errors[i].itemId);
            }
            Skritter.facade.show(&#x27;fixing &#x27; + errors.length + &#x27; sync issues&#x27;);
            Skritter.api.getItems(_.uniq(errorIds), _.bind(function(items) {
                var updated = Skritter.study.items.set(items, {add: false, remove: false});
                this.set(&#x27;lastReviewFix&#x27;, parseInt(errors[errors.length -1].created + 1, 10));
                callback(updated);
                Skritter.facade.hide();
            }, this));
        },
        /**
         * Adapts the stored values for animation speed into a format the application can use and
         * then returns it.
         * 
         * @method getAnimationSpeed
         * @returns {Number}
         */
        getAnimationSpeed: function() {
            var speed = this.getSetting(&#x27;animationSpeed&#x27;);
            return Math.ceil(Math.abs(1000 - (speed * 1000)));
        },
        /**
         * Gets the users current avatar and returns it as an image tag using base64 data.
         * 
         * @method getAvatar
         * @param {Boolean} fullsize Specifies wether is return the avatars original size
         * @returns {Image} Returns a base64 image tag
         */
        getAvatar: function(fullsize) {
            if (fullsize)
                return &quot;&lt;img src=&#x27;data:image/png;base64,&quot; + this.get(&#x27;settings&#x27;).avatar + &quot;&#x27; /&gt;&quot;;
            return &quot;&lt;img src=&#x27;data:image/png;base64,&quot; + this.get(&#x27;settings&#x27;).avatar + &quot;&#x27; width=&#x27;50&#x27; height=&#x27;50&#x27; /&gt;&quot;;
        },
        /**
         * Adapts the stored values for weight into a format the application can use and
         * then returns it.
         * 
         * @method getOrderStrictness
         * @returns {Number}
         */
        getOrderStrictness: function() {
            var strictness = Skritter.user.getSetting(&#x27;orderWeight&#x27;);
            return (strictness === 1) ? 0 : (Math.abs(4 - Math.ceil(strictness * 5)));
        },
        /**
         * A quicker way to get a setting from the user settings object.
         * 
         * @method getSetting
         * @param {String} name
         * @return {Object}
         */
        getSetting: function(name) {
            return this.get(&#x27;settings&#x27;)[name];
        },
        /**
         * Returns an array of active study parts based on the current language being studied.
         * 
         * @method getStudyParts
         * @returns {Array}
         */
        getStudyParts: function() {
            if (this.get(&#x27;settings&#x27;).targetLang === &#x27;zh&#x27;)
                return this.get(&#x27;settings&#x27;).chineseStudyParts;
            return this.get(&#x27;settings&#x27;).japaneseStudyParts;
        },
        /**
         * Checks to see if the user is logged in by seeing if a token exists. This might not always work
         * in situations where the token as expired.
         * 
         * @method isLoggedIn
         * @returns {Boolean} True or false pending the users login status
         */
        isLoggedIn: function() {
            if (this.get(&#x27;access_token&#x27;))
                return true;
            return false;
        },
        /**
         * Loads all of the data for the current active user into memory. For small to medium size accounts this is
         * fairly quick, but larger accounts might need to do loading in logical chunks.
         * 
         * @method loadAllData
         * @param {Function} callback
         */
        loadAllData: function(callback) {
            Skritter.async.parallel([
                //Skritter.async.apply(Skritter.log.loadAll),
                Skritter.async.apply(Skritter.study.decomps.loadAll),
                Skritter.async.apply(Skritter.study.items.loadAll),
                Skritter.async.apply(Skritter.study.params.loadAll),
                Skritter.async.apply(Skritter.study.reviews.loadAll),
                Skritter.async.apply(Skritter.study.srsconfigs.loadAll),
                Skritter.async.apply(Skritter.study.sentences.loadAll),
                Skritter.async.apply(Skritter.study.strokes.loadAll),
                Skritter.async.apply(Skritter.study.vocabs.loadAll)
            ], function() {
                callback();
            });
        },
        /**
         * Performs a complete login, stores the authentication data and also fetches the users settings from the server.
         * If the statusCode returned is anything but 200 then it doesn&#x27;t save, but returns the response message. It also creates or
         * opens the database for the user.
         * 
         * @method login
         * @param {String} username
         * @param {String} password
         * @param {Function} callback Returns the authentication response data
         */
        login: function(username, password, callback) {
            Skritter.api.authenticateUser(username, password, _.bind(function(response) {
                if (response.statusCode === 200) {
                    localStorage.setItem(&#x27;activeUser&#x27;, response.user_id);
                    Skritter.api.token = response.access_token;
                    this.set(response);
                    this.fetch(function() {
                        Skritter.storage.openDatabase(&#x27;skritdata-&#x27; + Skritter.user.get(&#x27;user_id&#x27;), function() {
                            callback(response);
                        });
                    });
                } else {
                    callback(response);
                }
            }, this));
        },
        /**
         * Automatically logs the user out and returns them to the home screen when called.
         * 
         * @method logout
         */
        logout: function() {
            Skritter.facade.show(&#x27;logging out&#x27;);
            Skritter.storage.deleteDatabase(function() {
                localStorage.removeItem(&#x27;activeUser&#x27;);
                Skritter.application.reload(function() {
                    Skritter.facade.hide();
                    document.location.hash = &#x27;&#x27;;
                });
            });
        },
        resetAllData: function() {
            Skritter.log.reset();
            Skritter.study.decomps.reset();
            Skritter.study.items.reset();
            Skritter.study.reviews.reset();
            Skritter.study.srsconfigs.reset();
            Skritter.study.sentences.reset();
            Skritter.study.strokes.reset();
            Skritter.study.strokes.loadTones();
            Skritter.study.vocabs.reset();
        },
        /**
         * A quicker way to set the user settings object.
         * 
         * @method setSetting
         * @param {String} name
         * @param {String} value
         * @return {Object}
         */
        setSetting: function(name, value) {
            var settings = this.get(&#x27;settings&#x27;);
            settings[name] = value;
            this.set(&#x27;settings&#x27;, settings);
            return this.get(&#x27;settings&#x27;);
        },
        /**
         * Syncs data with the server by getting changed items and posting reviews. If the account has never synced
         * this it initiates an full account download.
         * 
         * @method sync
         * @param {Function} callback
         * @param {Boolean} forceAccountDownload
         */
        sync: function(callback, forceAccountDownload) {
            if (this.get(&#x27;isSyncing&#x27;) &amp;&amp; !forceAccountDownload) {
                callback();
                return;
            }
            this.set(&#x27;isSyncing&#x27;, true);
            var self = this;
            var accountDownload;
            var requests;
            var size = 0;

            var process = function(requests) {
                Skritter.async.waterfall([
                    function(callback) {
                        Skritter.study.srsconfigs.fetch(function() {
                            callback();
                        });
                    },
                    function(callback) {
                        Skritter.api.requestBatch(requests, function(result) {
                            callback(null, result);
                        });
                    },
                    function(result, callback) {
                        Skritter.api.getBatch(result.id, function(result) {
                            size += result.responseSize;
                            if (accountDownload)
                                Skritter.facade.show(&#x27;initial download &lt;br /&gt;&#x27; + Skritter.fn.bytesToSize(size));
                            //ISSUE #20: decomps is returning a null value in the resulting array
                            Skritter.study.decomps.add(_.compact(result.Decomps));
                            Skritter.study.items.add(result.Items);
                            Skritter.study.srsconfigs.add(result.SRSConfigs);
                            Skritter.study.sentences.add(result.Sentences);
                            Skritter.study.strokes.add(result.Strokes);
                            Skritter.study.vocabs.add(result.Vocabs);
                        }, function() {
                            callback();
                        });
                    },
                    function(callback) {
                        Skritter.user.cacheAllData(function() {
                            callback();
                        });
                    }
                ], function() {
                    Skritter.user.set(&#x27;lastSync&#x27;, Skritter.fn.getUnixTime());
                    if (accountDownload) {
                        Skritter.facade.hide();
                        self.set(&#x27;isSyncing&#x27;, false);
                        self.set(&#x27;lastReviewFix&#x27;, Skritter.fn.getUnixTime());
                        if (typeof callback === &#x27;function&#x27;)
                            callback();
                    }
                });
            };

            if (this.get(&#x27;lastSync&#x27;) &amp;&amp; !forceAccountDownload) {
                //incremental sync from the last time a successful sync was performed
                callback();
                requests = [
                    {
                        path: &#x27;api/v0/items&#x27;,
                        method: &#x27;GET&#x27;,
                        cache: false,
                        params: {
                            sort: &#x27;changed&#x27;,
                            offset: this.get(&#x27;lastSync&#x27;),
                            include_vocabs: &#x27;true&#x27;,
                            include_strokes: &#x27;true&#x27;,
                            include_sentences: &#x27;true&#x27;,
                            include_heisigs: &#x27;true&#x27;,
                            include_top_mnemonics: &#x27;true&#x27;,
                            include_decomps: &#x27;true&#x27;
                        },
                        spawner: true
                    }
                ];
                process(requests);
            } else {
                //downloads the entire user account from the beginning of time
                //resets the collections and clears the database first
                Skritter.facade.show(&#x27;initial download &lt;br /&gt;&#x27;);
                this.resetAllData();
                accountDownload = true;
                requests = [
                    {
                        path: &#x27;api/v0/items&#x27;,
                        method: &#x27;GET&#x27;,
                        cache: false,
                        params: {
                            sort: &#x27;last&#x27;,
                            include_vocabs: &#x27;true&#x27;,
                            include_strokes: &#x27;true&#x27;,
                            include_sentences: &#x27;true&#x27;,
                            include_heisigs: &#x27;true&#x27;,
                            include_top_mnemonics: &#x27;true&#x27;,
                            include_decomps: &#x27;true&#x27;
                        },
                        spawner: true
                    }
                ];

                Skritter.storage.clear(function() {
                    process(requests);
                });
            }
        },
        /**
         * @method unsetSetting
         * @param {String} name
         * return {Object}
         */
        unsetSetting: function(name) {
            var settings = this.get(&#x27;settings&#x27;);
            delete settings[name];
            this.set(&#x27;settings&#x27;, settings);
            return settings;
        }
    });


    return User;
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
