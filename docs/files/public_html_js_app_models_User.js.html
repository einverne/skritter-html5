<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>public_html\js\app\models\User.js - Skritter HTML5: Documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Skritter HTML5: Documentation"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.334</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Assets.html">Assets</a></li>
            
                <li><a href="../classes/Canvas.html">Canvas</a></li>
            
                <li><a href="../classes/CanvasCharacter.html">CanvasCharacter</a></li>
            
                <li><a href="../classes/CanvasStroke.html">CanvasStroke</a></li>
            
                <li><a href="../classes/ContainedTable.html">ContainedTable</a></li>
            
                <li><a href="../classes/Decomp.html">Decomp</a></li>
            
                <li><a href="../classes/Decomps.html">Decomps</a></li>
            
                <li><a href="../classes/DecompTable.html">DecompTable</a></li>
            
                <li><a href="../classes/Functions.html">Functions</a></li>
            
                <li><a href="../classes/GradingButtons.html">GradingButtons</a></li>
            
                <li><a href="../classes/HomeView.html">HomeView</a></li>
            
                <li><a href="../classes/Item.html">Item</a></li>
            
                <li><a href="../classes/Items.html">Items</a></li>
            
                <li><a href="../classes/LeapController.html">LeapController</a></li>
            
                <li><a href="../classes/Libraries.html">Libraries</a></li>
            
                <li><a href="../classes/Log.html">Log</a></li>
            
                <li><a href="../classes/Mauler.html">Mauler</a></li>
            
                <li><a href="../classes/Modal.html">Modal</a></li>
            
                <li><a href="../classes/OptionsView.html">OptionsView</a></li>
            
                <li><a href="../classes/Param.html">Param</a></li>
            
                <li><a href="../classes/Params.html">Params</a></li>
            
                <li><a href="../classes/PinyinConverter.html">PinyinConverter</a></li>
            
                <li><a href="../classes/PromptData.html">PromptData</a></li>
            
                <li><a href="../classes/PromptDefn.html">PromptDefn</a></li>
            
                <li><a href="../classes/PromptItem.html">PromptItem</a></li>
            
                <li><a href="../classes/PromptRdng.html">PromptRdng</a></li>
            
                <li><a href="../classes/PromptRune.html">PromptRune</a></li>
            
                <li><a href="../classes/PromptTone.html">PromptTone</a></li>
            
                <li><a href="../classes/Recognizer.html">Recognizer</a></li>
            
                <li><a href="../classes/Review.html">Review</a></li>
            
                <li><a href="../classes/Reviews.html">Reviews</a></li>
            
                <li><a href="../classes/ReviewsView.html">ReviewsView</a></li>
            
                <li><a href="../classes/Router.html">Router</a></li>
            
                <li><a href="../classes/Scheduler.html">Scheduler</a></li>
            
                <li><a href="../classes/Sentence.html">Sentence</a></li>
            
                <li><a href="../classes/Sentences.html">Sentences</a></li>
            
                <li><a href="../classes/Settings.html">Settings</a></li>
            
                <li><a href="../classes/Shortstraw.html">Shortstraw</a></li>
            
                <li><a href="../classes/SimpTradMap.html">SimpTradMap</a></li>
            
                <li><a href="../classes/SRSConfigs.html">SRSConfigs</a></li>
            
                <li><a href="../classes/Stopwatch.html">Stopwatch</a></li>
            
                <li><a href="../classes/Stroke.html">Stroke</a></li>
            
                <li><a href="../classes/Strokes.html">Strokes</a></li>
            
                <li><a href="../classes/StudyView.html">StudyView</a></li>
            
                <li><a href="../classes/Sync.html">Sync</a></li>
            
                <li><a href="../classes/Tests.html">Tests</a></li>
            
                <li><a href="../classes/Timer.html">Timer</a></li>
            
                <li><a href="../classes/User.html">User</a></li>
            
                <li><a href="../classes/Vocab.html">Vocab</a></li>
            
                <li><a href="../classes/VocabInfoView.html">VocabInfoView</a></li>
            
                <li><a href="../classes/VocabList.html">VocabList</a></li>
            
                <li><a href="../classes/VocabListRowsTable.html">VocabListRowsTable</a></li>
            
                <li><a href="../classes/VocabListSection.html">VocabListSection</a></li>
            
                <li><a href="../classes/VocabListSectionsTable.html">VocabListSectionsTable</a></li>
            
                <li><a href="../classes/VocabListsTable.html">VocabListsTable</a></li>
            
                <li><a href="../classes/VocabListsView.html">VocabListsView</a></li>
            
                <li><a href="../classes/Vocabs.html">Vocabs</a></li>
            
                <li><a href="../classes/VocabsView.html">VocabsView</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Collection.html">Collection</a></li>
            
                <li><a href="../modules/Component.html">Component</a></li>
            
                <li><a href="../modules/Components.html">Components</a></li>
            
                <li><a href="../modules/Model.html">Model</a></li>
            
                <li><a href="../modules/Skritter.html">Skritter</a></li>
            
                <li><a href="../modules/Views.html">Views</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: public_html\js\app\models\User.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @module Skritter
 * @submodule Model
 * @param Decomps
 * @param Items
 * @param Params
 * @param Reviews
 * @param Scheduler
 * @param Sentences
 * @param SRSConfigs
 * @param Strokes
 * @param Sync
 * @param Vocabs
 * @author Joshua McFarland
 */
define([
    &#x27;collections/study/Decomps&#x27;,
    &#x27;collections/study/Items&#x27;,
    &#x27;collections/study/Params&#x27;,
    &#x27;collections/study/Reviews&#x27;,
    &#x27;models/Scheduler&#x27;,
    &#x27;collections/study/Sentences&#x27;,
    &#x27;collections/study/SRSConfigs&#x27;,
    &#x27;collections/study/Strokes&#x27;,
    &#x27;models/Sync&#x27;,
    &#x27;collections/study/Vocabs&#x27;,
    &#x27;collections/VocabLists&#x27;
], function(Decomps, Items, Params, Reviews, Scheduler, Sentences, SRSConfigs, Strokes, Sync, Vocabs, VocabLists) {
    /**
     * @class User
     */
    var User = Backbone.Model.extend({
        /**
         * @method initialize
         */
        initialize: function() {
            User.this = this;
            //initializes all of the required data collections
            skritter.data = {
                decomps: new Decomps(),
                items: new Items(),
                params: new Params(),
                reviews: new Reviews(),
                srsconfigs: new SRSConfigs(),
                sentences: new Sentences(),
                strokes: new Strokes(),
                vocabs: new Vocabs()
            };
            //initialize the user lists separate from study data
            skritter.lists = new VocabLists();
            //loads the user from localStorage if exists
            if (localStorage.getItem(&#x27;activeUser&#x27;)) {
                try {
                    this.set(JSON.parse(localStorage.getItem(localStorage.getItem(&#x27;activeUser&#x27;))));
                } catch (error) {
                    if (error instanceof SyntaxError) {
                        localStorage.removeItem(localStorage.getItem(&#x27;activeUser&#x27;));
                        localStorage.removeItem(&#x27;activeUser&#x27;);
                    }
                }
            }
            //performs special loading tasks when user is logged in
            if (this.isLoggedIn()) {
                skritter.api.set(&#x27;token&#x27;, this.get(&#x27;access_token&#x27;));
                skritter.scheduler = new Scheduler();
                skritter.sync = new Sync();
            }
            //stores user settings to localStorage as they are changed
            this.on(&#x27;change&#x27;, this.cache);
        },
        /**
         * @property {Object} defaults
         */
        defaults: {
            access_token: null,
            audio: false,
            autoSync: true,
            autoSyncThreshold: 10,
            expires_in: null,
            filterChineseParts: [&#x27;defn&#x27;, &#x27;rdng&#x27;, &#x27;rune&#x27;, &#x27;tone&#x27;],
            filterJapaneseParts: [&#x27;defn&#x27;, &#x27;rdng&#x27;, &#x27;rune&#x27;],
            lastLogin: null,
            lastSyncChinese: null,
            lastSyncJapanese: null,
            refresh_token: null,
            settings: {},
            token_type: null,
            user_id: &#x27;guest&#x27;
        },
        /**
         * @method cache
         */
        cache: function() {
            if (this.isLoggedIn())
                localStorage.setItem(this.get(&#x27;user_id&#x27;), JSON.stringify(this));
        },
        /**
         * @method addItems
         * @param {Number} limit
         * @param {Function} callback
         */
        addItems: function(limit, callback) {
            limit = (limit) ? limit : 1;
            skritter.sync.addItems(this.getLastSync(), limit, callback);
        },
        /**
         * @method fetch
         * @param {Function} callback
         */
        fetch: function(callback) {
            if (this.isLoggedIn())
                skritter.api.getUser(this.get(&#x27;user_id&#x27;), function(data) {
                    User.this.set(&#x27;settings&#x27;, data);
                    callback(data);
                });
        },
        /**
         * Returns an array of active parts based on the current language being studied.
         * 
         * @method getActiveParts
         * @returns {Array}
         */
        getActiveParts: function() {
            if (this.isChinese())
                return this.get(&#x27;filterChineseParts&#x27;);
            return this.get(&#x27;filterJapaneseParts&#x27;);
        },
        /**
         * Gets the users current avatar and returns it as an image tag using base64 data.
         * 
         * @method getAvatar
         * @param {String} classes
         * @returns {Image} Returns a base64 image tag
         */
        getAvatar: function(classes) {
            if (classes)
                return &quot;&lt;img src=&#x27;data:image/png;base64,&quot; + this.getSetting(&#x27;avatar&#x27;) + &quot;&#x27; + class=&#x27;&quot; + classes + &quot;&#x27; /&gt;&quot;;
            return &quot;&lt;img src=&#x27;data:image/png;base64,&quot; + this.getSetting(&#x27;avatar&#x27;) + &quot;&#x27; /&gt;&quot;;
        },
        /**
         * Mainly used on tone prompts to determine which font to draw the character from, but
         * it returns the name of the font based on the current target language.
         * 
         * @method getFontName
         * @returns {String}
         */
        getFontName: function() {
            if (this.isChinese())
                return &#x27;simkai&#x27;;
            return &#x27;kaisho&#x27;;
        },
        getLastSync: function() {
            var lastSync = (this.isChinese()) ? this.get(&#x27;lastSyncChinese&#x27;) : this.get(&#x27;lastSyncJapanese&#x27;);
            if (lastSync)
                return lastSync;
            return 0;
        },
        /**
         * A shortcut method for getting user server settings.
         * 
         * @method getSetting
         * @param {String} name
         * @return {Object}
         */
        getSetting: function(name) {
            return this.get(&#x27;settings&#x27;)[name];
        },
        /**
         * Returns the current style which really only applies to Chinese as both,
         * simplified or traditional.
         * 
         * @method getStyle
         * @returns {Array}
         */
        getStyle: function() {
            if (this.isJapanese()) {
                return [];
            } else if (this.isChinese() &amp;&amp; this.getSetting(&#x27;reviewSimplified&#x27;) &amp;&amp; this.getSetting(&#x27;reviewTraditional&#x27;)) {
                return [&#x27;both&#x27;, &#x27;simp&#x27;, &#x27;trad&#x27;];
            } else if (this.isChinese() &amp;&amp; this.getSetting(&#x27;reviewSimplified&#x27;) &amp;&amp; !this.getSetting(&#x27;reviewTraditional&#x27;)) {
                return [&#x27;both&#x27;, &#x27;simp&#x27;];
            } else {
                return [&#x27;both&#x27;, &#x27;trad&#x27;];
            }
        },
        /**
         * @method getStyleString
         * @returns {String}
         */
        getStyleString: function() {
            if (this.isJapanese()) {
                return &#x27;all&#x27;;
            } else if (this.isChinese() &amp;&amp; this.getSetting(&#x27;reviewSimplified&#x27;) &amp;&amp; this.getSetting(&#x27;reviewTraditional&#x27;)) {
                return &#x27;both&#x27;;
            } else if (this.isChinese() &amp;&amp; this.getSetting(&#x27;reviewSimplified&#x27;) &amp;&amp; !this.getSetting(&#x27;reviewTraditional&#x27;)) {
                return &#x27;simp&#x27;;
            } else {
                return &#x27;trad&#x27;;
            }
        },
        /**
         * @method getTextStyle
         * @returns {String}
         */
        getTextStyle: function() {
            if (this.isChinese())
                return &#x27;chinese-text&#x27;;
            return &#x27;japanese-text&#x27;;
        },
        /**
         * Returns true if the target language is set to Chinese.
         * 
         * @method isChinese
         * @returns {Boolean}
         */
        isChinese: function() {
            if (this.getSetting(&#x27;targetLang&#x27;) === &#x27;zh&#x27;)
                return true;
            return false;
        },
        /**
         * Returns true if the target language is set to Japanese.
         * 
         * @method isJapanese
         * @returns {Boolean}
         */
        isJapanese: function() {
            if (this.getSetting(&#x27;targetLang&#x27;) === &#x27;ja&#x27;)
                return true;
            return false;
        },
        /**
         * @method isLoggedIn
         * @returns {Boolean}
         */
        isLoggedIn: function() {
            if (this.get(&#x27;access_token&#x27;))
                return true;
            return false;
        },
        loadData: function(callback) {
            async.series([
                async.apply(skritter.data.decomps.loadAll),
                async.apply(skritter.data.reviews.loadAll),
                async.apply(skritter.scheduler.loadAll),
                async.apply(skritter.data.sentences.loadAll),
                async.apply(skritter.data.srsconfigs.loadAll),
                async.apply(skritter.data.strokes.loadAll)
            ], function() {
                callback();
            });
        },
        login: function(username, password, callback) {
            skritter.api.authenticateUser(username, password, function(result) {
                if (result.statusCode === 200) {
                    User.this.set(result);
                    skritter.api.set(&#x27;token&#x27;, result.access_token);
                    User.this.fetch(function() {
                        skritter.storage.openDatabase(skritter.user.get(&#x27;user_id&#x27;), function() {
                            localStorage.setItem(&#x27;activeUser&#x27;, result.user_id);
                            User.this.set(&#x27;lastLogin&#x27;, skritter.fn.getUnixTime());
                            callback(result);
                        });
                    });
                } else {
                    callback(result);
                }
            });
        },
        logout: function() {
            if (this.isLoggedIn()) {
                skritter.modal.show().setBody(&#x27;Logging Out&#x27;).noHeader();
                skritter.storage.deleteDatabase(function() {
                    localStorage.removeItem(&#x27;activeUser&#x27;);
                    document.location.reload(true);
                });
            }
        },
        /**
         * @method setActiveParts
         * @param {Array} parts
         */
        setActiveParts: function(parts) {
            if (skritter.user.isChinese()) {
                this.set(&#x27;filterChineseParts&#x27;, parts);
            } else {
                this.set(&#x27;filterJapaneseParts&#x27;, parts);
            }
        },
        /**
         * @method setLastSync
         * @param {Number} time
         * @returns {Number}
         */
        setLastSync: function(time) {
            time = (time) ? time : skritter.fn.getUnixTime();
            if (this.isChinese()) {
                this.set(&#x27;lastSyncChinese&#x27;, time);
            } else {
                this.set(&#x27;lastSyncJapanese&#x27;, time);
            }
            return time;
        },
        /**
         * A shortcut method for changing user server settings.
         * 
         * @method setSetting
         * @param {String} name
         * @param {String} value
         * @return {Backbone.Model}
         */
        setSetting: function(name, value) {
            var settings = this.get(&#x27;settings&#x27;);
            settings[name] = value;
            this.set(&#x27;settings&#x27;, settings);
            return this;
        },
        /**
         * @method sync
         * @param {Function} callback
         * @returns {Backbone.Model}
         */
        sync: function(callback) {
            if (!skritter.sync.isSyncing()) {
                skritter.sync.full(this.getLastSync(), function(error) {
                    if (!error)
                        User.this.setLastSync();
                    if (typeof callback === &#x27;function&#x27;)
                        callback(error);
                });
            } else {
                if (typeof callback === &#x27;function&#x27;)
                    callback();
            }
        },
        /**
         * A shortcut method for removing user server settings.
         * 
         * @method unsetSetting
         * @param {String} name
         * return {Object}
         */
        unsetSetting: function(name) {
            var settings = this.get(&#x27;settings&#x27;);
            delete settings[name];
            this.set(&#x27;settings&#x27;, settings);
            return settings;
        }
    });

    return User;
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
