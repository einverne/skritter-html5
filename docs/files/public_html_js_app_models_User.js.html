<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>public_html\js\app\models\User.js - Skritter HTML5: Documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Skritter HTML5: Documentation"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.108</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Api.html">Api</a></li>
            
                <li><a href="../classes/Application.html">Application</a></li>
            
                <li><a href="../classes/Assets.html">Assets</a></li>
            
                <li><a href="../classes/Canvas.html">Canvas</a></li>
            
                <li><a href="../classes/CanvasCharacter.html">CanvasCharacter</a></li>
            
                <li><a href="../classes/CanvasStroke.html">CanvasStroke</a></li>
            
                <li><a href="../classes/Functions.html">Functions</a></li>
            
                <li><a href="../classes/GradingButtons.html">GradingButtons</a></li>
            
                <li><a href="../classes/Home.html">Home</a></li>
            
                <li><a href="../classes/IndexedDBAdapter.html">IndexedDBAdapter</a></li>
            
                <li><a href="../classes/Info.html">Info</a></li>
            
                <li><a href="../classes/Lists.html">Lists</a></li>
            
                <li><a href="../classes/Mauler.html">Mauler</a></li>
            
                <li><a href="../classes/Modal.html">Modal</a></li>
            
                <li><a href="../classes/PinyinConverter.html">PinyinConverter</a></li>
            
                <li><a href="../classes/PromptCanvas.html">PromptCanvas</a></li>
            
                <li><a href="../classes/PromptDefn.html">PromptDefn</a></li>
            
                <li><a href="../classes/PromptRdng.html">PromptRdng</a></li>
            
                <li><a href="../classes/PromptRune.html">PromptRune</a></li>
            
                <li><a href="../classes/PromptTone.html">PromptTone</a></li>
            
                <li><a href="../classes/Recognizer.html">Recognizer</a></li>
            
                <li><a href="../classes/Reviews.html">Reviews</a></li>
            
                <li><a href="../classes/Router.html">Router</a></li>
            
                <li><a href="../classes/Scheduler.html">Scheduler</a></li>
            
                <li><a href="../classes/Settings.html">Settings</a></li>
            
                <li><a href="../classes/Shortstraw.html">Shortstraw</a></li>
            
                <li><a href="../classes/Stopwatch.html">Stopwatch</a></li>
            
                <li><a href="../classes/StudyDecomp.html">StudyDecomp</a></li>
            
                <li><a href="../classes/StudyDecomps.html">StudyDecomps</a></li>
            
                <li><a href="../classes/StudyItem.html">StudyItem</a></li>
            
                <li><a href="../classes/StudyItems.html">StudyItems</a></li>
            
                <li><a href="../classes/StudyParam.html">StudyParam</a></li>
            
                <li><a href="../classes/StudyParams.html">StudyParams</a></li>
            
                <li><a href="../classes/StudyReview.html">StudyReview</a></li>
            
                <li><a href="../classes/StudyReviews.html">StudyReviews</a></li>
            
                <li><a href="../classes/StudySentence.html">StudySentence</a></li>
            
                <li><a href="../classes/StudySentences.html">StudySentences</a></li>
            
                <li><a href="../classes/StudySRSConfigs.html">StudySRSConfigs</a></li>
            
                <li><a href="../classes/StudyStroke.html">StudyStroke</a></li>
            
                <li><a href="../classes/StudyStrokes.html">StudyStrokes</a></li>
            
                <li><a href="../classes/StudyVocab.html">StudyVocab</a></li>
            
                <li><a href="../classes/StudyVocabs.html">StudyVocabs</a></li>
            
                <li><a href="../classes/Sync.html">Sync</a></li>
            
                <li><a href="../classes/Timer.html">Timer</a></li>
            
                <li><a href="../classes/User.html">User</a></li>
            
                <li><a href="../classes/Vocabs.html">Vocabs</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Collection.html">Collection</a></li>
            
                <li><a href="../modules/Component.html">Component</a></li>
            
                <li><a href="../modules/Components.html">Components</a></li>
            
                <li><a href="../modules/Model.html">Model</a></li>
            
                <li><a href="../modules/Prompts.html">Prompts</a></li>
            
                <li><a href="../modules/Skritter.html">Skritter</a></li>
            
                <li><a href="../modules/Storage.html">Storage</a></li>
            
                <li><a href="../modules/Views.html">Views</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: public_html\js\app\models\User.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @module Skritter
 * @submodule Model
 * @param Sync
 * @param StudyDecomps
 * @param StudyItems
 * @param StudyParams
 * @param StudyReviews
 * @param StudySRSConfigs
 * @param StudySentences
 * @param StudyStrokes
 * @param StudyVocabs
 * @author Joshua McFarland
 */
define([
    &#x27;Sync&#x27;,
    &#x27;collections/StudyDecomps&#x27;,
    &#x27;collections/StudyItems&#x27;,
    &#x27;collections/StudyParams&#x27;,
    &#x27;collections/StudyReviews&#x27;,
    &#x27;collections/StudySRSConfigs&#x27;,
    &#x27;collections/StudySentences&#x27;,
    &#x27;collections/StudyStrokes&#x27;,
    &#x27;collections/StudyVocabs&#x27;,
    &#x27;backbone&#x27;,
    &#x27;lz-string&#x27;
], function(Sync, StudyDecomps, StudyItems, StudyParams, StudyReviews, StudySRSConfigs, StudySentences, StudyStrokes, StudyVocabs) {
    /**
     * @class User
     */
    var User = Backbone.Model.extend({
        /**
         * @method initialize
         */
        initialize: function() {
            //initializes all of the required data collections
            skritter.data = {
                decomps: new StudyDecomps(),
                items: new StudyItems(),
                params: new StudyParams(),
                reviews: new StudyReviews(),
                srsconfigs: new StudySRSConfigs(),
                sentences: new StudySentences(),
                strokes: new StudyStrokes(),
                vocabs: new StudyVocabs()
            };
            //loads the user from localStorage if exists
            if (localStorage.getItem(&#x27;activeUser&#x27;))
                this.set(JSON.parse(LZString.decompress(localStorage.getItem(localStorage.getItem(&#x27;activeUser&#x27;)))));
            //perform tasks based login status
            if (this.isLoggedIn()) {
                //sets the api token required for calls
                skritter.api.token = this.get(&#x27;access_token&#x27;);
            }
            //stores user settings to localStorage as they are changed
            this.on(&#x27;change&#x27;, this.cache);
        },
        /**
         * @property {Object} defaults
         */
        defaults: {
            access_token: null,
            addOffset: 0,
            audio: true,
            expires_in: null,
            lastLogin: null,
            lastSyncChinese: null,
            lastSyncJapanese: null,
            refresh_token: null,
            settings: null,
            syncMethod: &#x27;full&#x27;,
            token_type: null,
            user_id: null
        },
        /**
         * @method cache
         */
        cache: function() {
            if (this.isLoggedIn())
                localStorage.setItem(this.get(&#x27;user_id&#x27;), LZString.compress(JSON.stringify(this)));
        },
        /**
         * @method addItems
         * @param {Number} limit
         * @param {Function} callback
         */
        addItems: function(limit, callback) {
            var self = this;
            var offset = this.get(&#x27;addOffset&#x27;);
            limit = (limit) ? limit : 1;
            var requests = [
                {
                    path: &#x27;api/v&#x27; + skritter.api.version + &#x27;/items/add&#x27;,
                    method: &#x27;POST&#x27;,
                    cache: false,
                    params: {
                        lang: this.getSetting(&#x27;targetLang&#x27;),
                        limit: limit,
                        offset: offset
                    }
                }
            ];
            skritter.async.waterfall([
                //request the new items using a batch request
                function(callback) {
                    skritter.modal.setProgress(100, &#x27;Requesting Items&#x27;);
                    skritter.api.requestBatch(requests, function(result) {
                        callback(null, result);
                    });
                },
                //start fetching the new items as they are completed
                function(result, callback) {
                    skritter.modal.setProgress(100, &#x27;Getting Items&#x27;);
                    skritter.api.getBatchCombined(result.id, function(result) {
                        console.log(&#x27;added items&#x27;, result);
                    }, function() {
                        callback();
                    });
                },
                //run a fresh sync to get the new items and update
                function(callback) {
                    self.set(&#x27;addOffset&#x27;, offset + 1);
                    self.sync(callback);
                }
            ], function() {
                if (typeof callback === &#x27;function&#x27;)
                    callback();
            });
        },
        /**
         * @method checkReviewErrors
         * @param {Number} offset
         * @param {Function} callback
         */
        checkReviewErrors: function(callback, offset) {
            offset = (offset &amp;&amp; offset &gt; -1) ? offset : this.getLastSync();
            skritter.api.getReviewErrors(offset, function(errors) {
                console.log(&#x27;Review Errors&#x27;, errors);
                if (typeof callback === &#x27;function&#x27;)
                    callback(errors);
            });
        },
        /**
         * Gets the current users properties and settings from the server then saves it.
         * 
         * @method fetch
         * @param {Function} callback
         */
        fetch: function(callback) {
            var self = this;
            if (this.isLoggedIn()) {
                skritter.api.getUser(this.get(&#x27;user_id&#x27;), function(data) {
                    self.set(&#x27;settings&#x27;, data);
                    callback(data);
                });
            }
        },
        /**
         * Gets the users current avatar and returns it as an image tag using base64 data.
         * 
         * @method getAvatar
         * @param {String} classes
         * @returns {Image} Returns a base64 image tag
         */
        getAvatar: function(classes) {
            if (classes)
                return &quot;&lt;img src=&#x27;data:image/png;base64,&quot; + this.getSetting(&#x27;avatar&#x27;) + &quot;&#x27; + class=&#x27;&quot; + classes + &quot;&#x27; /&gt;&quot;;
            return &quot;&lt;img src=&#x27;data:image/png;base64,&quot; + this.getSetting(&#x27;avatar&#x27;) + &quot;&#x27; /&gt;&quot;;
        },
        /**
         * Returns an array of active study parts based on the current language being studied.
         * 
         * @method getActiveStudyParts
         * @returns {Array}
         */
        getActiveStudyParts: function() {
            if (this.isChinese())
                return this.get(&#x27;settings&#x27;).chineseStudyParts;
            return this.get(&#x27;settings&#x27;).japaneseStudyParts;
        },
        /**
         * @method getDatabaseId
         * @returns {undefined}
         */
        getDatabaseName: function() {
            return this.get(&#x27;user_id&#x27;);
        },
        /**
         * Mainly used on tone prompts to determine which font to draw the character from, but
         * it returns the name of the font based on the current target language.
         * 
         * @method getFontName
         * @returns {String}
         */
        getFontName: function() {
            if (this.isChinese())
                return &#x27;simkai&#x27;;
            return &#x27;kaisho&#x27;;
        },
        /**
         * Returns the last sync based on the current active language. This is needed so we don&#x27;t
         * have to delete all of the data when switching languages.
         * 
         * @method getLastSync
         * @returns {Number}
         */
        getLastSync: function() {
            var lastSync = (this.isChinese()) ? this.get(&#x27;lastSyncChinese&#x27;) : this.get(&#x27;lastSyncJapanese&#x27;);
            if (lastSync)
                return lastSync;
            return 0;
        },
        /**
         * A shortcut method for getting user server settings.
         * 
         * @method getSetting
         * @param {String} name
         * @return {Object}
         */
        getSetting: function(name) {
            return this.get(&#x27;settings&#x27;)[name];
        },
        /**
         * Returns the current style which really only applies to Chinese as both,
         * simplified or traditional.
         * 
         * @method getStyle
         * @returns {String}
         */
        getStyle: function() {
            if (this.isJapanese()) {
                return &#x27;ja&#x27;;
            } else if (this.isChinese() &amp;&amp; this.getSetting(&#x27;addSimplified&#x27;) &amp;&amp; this.getSetting(&#x27;addTraditional&#x27;)) {
                return &#x27;zh-both&#x27;;
            } else if (this.isChinese() &amp;&amp; this.getSetting(&#x27;addSimplified&#x27;) &amp;&amp; !this.getSetting(&#x27;addTraditional&#x27;)) {
                return &#x27;zh-simp&#x27;;
            } else {
                return &#x27;zh-trad&#x27;;
            }
        },
        /**
         * @method getTextStyle
         * @returns {String}
         */
        getTextStyle: function() {
            if (this.isChinese())
                return &#x27;chinese-text&#x27;;
            return &#x27;japanese-text&#x27;;
        },
        /**
         * Returns true if the target language is set to Chinese.
         * 
         * @method isChinese
         * @returns {Boolean}
         */
        isChinese: function() {
            if (this.getSetting(&#x27;targetLang&#x27;) === &#x27;zh&#x27;)
                return true;
            return false;
        },
        /**
         * Returns true if the target language is set to Japanese.
         * 
         * @method isJapanese
         * @returns {Boolean}
         */
        isJapanese: function() {
            if (this.getSetting(&#x27;targetLang&#x27;) === &#x27;ja&#x27;)
                return true;
            return false;
        },
        /**
         * Checks to see if the user is logged in by seeing if a token exists. This might not always work
         * in situations where the token as expired.
         * 
         * @method isLoggedIn
         * @returns {Boolean} True or false pending the users login status
         */
        isLoggedIn: function() {
            if (this.get(&#x27;access_token&#x27;))
                return true;
            return false;
        },
        /**
         * Loads all of the data for the current active user into memory. For small to medium size accounts this is
         * fairly quick, but larger accounts might need to do loading in logical chunks.
         * 
         * @method loadAllData
         * @param {Function} callback
         */
        loadAllData: function(callback) {
            skritter.async.series([
                skritter.async.apply(skritter.data.decomps.loadAll),
                skritter.async.apply(skritter.data.params.loadAll),
                skritter.async.apply(skritter.data.reviews.loadAll),
                skritter.async.apply(skritter.data.srsconfigs.loadAll),
                skritter.async.apply(skritter.data.sentences.loadAll),
                skritter.async.apply(skritter.data.strokes.loadAll),
                skritter.async.apply(skritter.data.vocabs.loadAll),
                skritter.async.apply(skritter.data.items.loadAll)
            ], callback);
        },
        /**
         * @method login
         * @param {String} username
         * @param {String} password
         * @param {Function} callback
         */
        login: function(username, password, callback) {
            var self = this;
            skritter.api.authenticateUser(username, password, function(result) {
                if (result.statusCode === 200) {
                    self.set(result);
                    skritter.api.token = result.access_token;
                    self.fetch(function() {
                        skritter.storage.openDatabase(skritter.user.get(&#x27;user_id&#x27;), function() {
                            localStorage.setItem(&#x27;activeUser&#x27;, result.user_id);
                            self.set(&#x27;lastLogin&#x27;, skritter.fn.getUnixTime());
                            callback(result);
                        });
                    });
                } else {
                    callback(result);
                }
            });
        },
        /**
         * Automatically logs the user out and returns them to home.
         * 
         * @method logout
         */
        logout: function() {
            if (this.isLoggedIn()) {
                skritter.modal.show().setBody(&#x27;Logging Out&#x27;).noHeader();
                skritter.storage.deleteAllDatabases(function() {
                    localStorage.removeItem(&#x27;activeUser&#x27;);
                    skritter.router.navigate(&#x27;&#x27;, {trigger: true, replace: true});
                    document.location.reload();
                });
            }
        },
        /**
         * @method setLastSync
         * @param {Number} time
         * @returns {Number}
         */
        setLastSync: function(time) {
            time = (time) ? time : skritter.fn.getUnixTime();
            if (this.isChinese()) {
                this.set(&#x27;lastSyncChinese&#x27;, time);
            } else {
                this.set(&#x27;lastSyncJapanese&#x27;, time);
            }
            return time;
        },
        /**
         * A shortcut method for changing user server settings.
         * 
         * @method setSetting
         * @param {String} name
         * @param {String} value
         * @return {Backbone.Model}
         */
        setSetting: function(name, value) {
            var settings = this.get(&#x27;settings&#x27;);
            settings[name] = value;
            this.set(&#x27;settings&#x27;, settings);
            return this;
        },
        /**
         * @method sync
         * @param {Function} callback
         */
        sync: function(callback) {
            var self = this;
            console.log(&#x27;syncing from&#x27;, skritter.moment(this.getLastSync() * 1000).format(&#x27;YYYY[-]MM[-]DD h:mm:ss a&#x27;));
            skritter.async.waterfall([
                /*function(callback) {
                 skritter.modal.setProgress(100, &#x27;Getting Schedule&#x27;);
                 skritter.api.getItemsCondensed(function(result) {
                 console.log(&#x27;condensed&#x27;, result);
                 callback(null, result);
                 });
                 },
                 function(result, callback) {
                 skritter.modal.setProgress(100, &#x27;Saving Schedule&#x27;);
                 skritter.data.items.add(result.Items, {merge: true});
                 skritter.data.items.cache(callback);
                 },*/
                function() {
                    switch (self.get(&#x27;syncMethod&#x27;)) {
                        case &#x27;flash&#x27;:
                            Sync.methodFlash(callback);
                            break;
                        case &#x27;full&#x27;:
                            Sync.methodFull(callback);
                            break;
                        case &#x27;partial&#x27;:
                            Sync.methodPartial(callback);
                            break;
                    }
                }
            ], function() {
                self.setLastSync();
                callback();
            });

            /*skritter.api.getItemsCondensed(function(items) {
             console.log(&#x27;condensed items&#x27;, items);
             switch (self.get(&#x27;syncMethod&#x27;)) {
             case &#x27;flash&#x27;:
             Sync.methodFlash(callback);
             break;
             case &#x27;full&#x27;:
             Sync.methodFull(callback);
             break;
             case &#x27;partial&#x27;:
             Sync.methodPartial(callback);
             break;
             }
             }, this.getLastSync());*/
        },
        /**
         * A shortcut method for removing user server settings.
         * 
         * @method unsetSetting
         * @param {String} name
         * return {Object}
         */
        unsetSetting: function(name) {
            var settings = this.get(&#x27;settings&#x27;);
            delete settings[name];
            this.set(&#x27;settings&#x27;, settings);
            return settings;
        }
    });

    return User;
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
