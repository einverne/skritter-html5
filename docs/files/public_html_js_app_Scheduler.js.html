<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>public_html\js\app\Scheduler.js - Skritter HTML5: Documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Skritter HTML5: Documentation"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.137</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Api.html">Api</a></li>
            
                <li><a href="../classes/Application.html">Application</a></li>
            
                <li><a href="../classes/Assets.html">Assets</a></li>
            
                <li><a href="../classes/Canvas.html">Canvas</a></li>
            
                <li><a href="../classes/CanvasCharacter.html">CanvasCharacter</a></li>
            
                <li><a href="../classes/CanvasStroke.html">CanvasStroke</a></li>
            
                <li><a href="../classes/Functions.html">Functions</a></li>
            
                <li><a href="../classes/GradingButtons.html">GradingButtons</a></li>
            
                <li><a href="../classes/Home.html">Home</a></li>
            
                <li><a href="../classes/IndexedDBAdapter.html">IndexedDBAdapter</a></li>
            
                <li><a href="../classes/Info.html">Info</a></li>
            
                <li><a href="../classes/Lists.html">Lists</a></li>
            
                <li><a href="../classes/Mauler.html">Mauler</a></li>
            
                <li><a href="../classes/Modal.html">Modal</a></li>
            
                <li><a href="../classes/PinyinConverter.html">PinyinConverter</a></li>
            
                <li><a href="../classes/Prompt.html">Prompt</a></li>
            
                <li><a href="../classes/PromptCanvas.html">PromptCanvas</a></li>
            
                <li><a href="../classes/PromptDefn.html">PromptDefn</a></li>
            
                <li><a href="../classes/PromptRdng.html">PromptRdng</a></li>
            
                <li><a href="../classes/PromptRune.html">PromptRune</a></li>
            
                <li><a href="../classes/PromptTone.html">PromptTone</a></li>
            
                <li><a href="../classes/Recognizer.html">Recognizer</a></li>
            
                <li><a href="../classes/Reviews.html">Reviews</a></li>
            
                <li><a href="../classes/Router.html">Router</a></li>
            
                <li><a href="../classes/Scheduler.html">Scheduler</a></li>
            
                <li><a href="../classes/Settings.html">Settings</a></li>
            
                <li><a href="../classes/Shortstraw.html">Shortstraw</a></li>
            
                <li><a href="../classes/Stopwatch.html">Stopwatch</a></li>
            
                <li><a href="../classes/StudyDecomp.html">StudyDecomp</a></li>
            
                <li><a href="../classes/StudyDecomps.html">StudyDecomps</a></li>
            
                <li><a href="../classes/StudyItem.html">StudyItem</a></li>
            
                <li><a href="../classes/StudyItems.html">StudyItems</a></li>
            
                <li><a href="../classes/StudyParam.html">StudyParam</a></li>
            
                <li><a href="../classes/StudyParams.html">StudyParams</a></li>
            
                <li><a href="../classes/StudyReview.html">StudyReview</a></li>
            
                <li><a href="../classes/StudyReviews.html">StudyReviews</a></li>
            
                <li><a href="../classes/StudySentence.html">StudySentence</a></li>
            
                <li><a href="../classes/StudySentences.html">StudySentences</a></li>
            
                <li><a href="../classes/StudySRSConfigs.html">StudySRSConfigs</a></li>
            
                <li><a href="../classes/StudyStroke.html">StudyStroke</a></li>
            
                <li><a href="../classes/StudyStrokes.html">StudyStrokes</a></li>
            
                <li><a href="../classes/StudyVocab.html">StudyVocab</a></li>
            
                <li><a href="../classes/StudyVocabs.html">StudyVocabs</a></li>
            
                <li><a href="../classes/Sync.html">Sync</a></li>
            
                <li><a href="../classes/Timer.html">Timer</a></li>
            
                <li><a href="../classes/User.html">User</a></li>
            
                <li><a href="../classes/Vocabs.html">Vocabs</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Collection.html">Collection</a></li>
            
                <li><a href="../modules/Component.html">Component</a></li>
            
                <li><a href="../modules/Components.html">Components</a></li>
            
                <li><a href="../modules/Model.html">Model</a></li>
            
                <li><a href="../modules/Prompts.html">Prompts</a></li>
            
                <li><a href="../modules/Skritter.html">Skritter</a></li>
            
                <li><a href="../modules/Storage.html">Storage</a></li>
            
                <li><a href="../modules/Views.html">Views</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: public_html\js\app\Scheduler.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @module Skritter
 * @author Joshua McFarland
 */
define(function() {
    /**
     * A group of functions that can be used for scheduling items.
     * 
     * @class Scheduler
     */
    function Scheduler() {
        this.history = [];
        this.schedule = [];
    }
    
    /**
     * @method filter
     * @param {Array} parts
     * @param {Array} styles
     * @returns {Array}
     */
    Scheduler.prototype.filter = function(parts, styles) {
        parts = (parts) ? parts : skritter.user.getActiveStudyParts();
        styles = (styles) ? styles : skritter.user.getStyle();  
        this.schedule = this.schedule.filter(function(item) {
            if (item.vocabIds.length === 0)
                return false;
            if (!_.contains(parts, item.part))
                return false;
            if (styles.length &gt; 0 &amp;&amp; !_.contains(styles, item.style))
                return false;
            return true;
        });
        return this.schedule;
    };
    
    /**
     * @method getDue
     * @returns {Array}
     */
    Scheduler.prototype.getDue = function() {
        return this.schedule.filter(function(item) {
            if (item.readiness &gt;= 1.0)
                return true;
            return false;
        });
    };

    /**
     * @method getDueCount
     * @returns {Number}
     */
    Scheduler.prototype.getDueCount = function() {
        return this.getDue().length;
    };

    /**
     * Returns a calculated interval based on the grade and other details about the item.
     * 
     * @method getInterval
     * @param {StudyItem} item
     * @param {Number} grade
     * @returns {Number}
     */
    Scheduler.prototype.getInterval = function(item, grade) {
        var config = skritter.data.srsconfigs.findWhere({lang: skritter.user.getSetting(&#x27;targetLang&#x27;), part: item.get(&#x27;part&#x27;)});
        var newInterval;
        var getRandomizedInterval = function(interval) {
            return Math.round(interval * (0.925 + (Math.random() * 0.15)));
        };
        //return new items with randomized default config values
        if (!item.has(&#x27;last&#x27;)) {
            switch (grade) {
                case 1:
                    newInterval = config.get(&#x27;initialWrongInterval&#x27;);
                    break;
                case 2:
                    newInterval = config.get(&#x27;initialRightInterval&#x27;) / 5;
                    break;
                case 3:
                    newInterval = config.get(&#x27;initialRightInterval&#x27;);
                    break;
                case 4:
                    newInterval = config.get(&#x27;initialRightInterval&#x27; * 4);
                    break;
            }
            return getRandomizedInterval(newInterval);
        }
        //set values for further calculations
        var actualInterval = skritter.fn.getUnixTime() - item.get(&#x27;last&#x27;);
        var factor;
        var pctRight = item.get(&#x27;successes&#x27;) / item.get(&#x27;reviews&#x27;);
        var scheduledInterval = item.get(&#x27;next&#x27;) - item.get(&#x27;last&#x27;);
        //get the factor 
        if (grade === 2) {
            factor = 0.9;
        } else if (grade === 4) {
            factor = 3.5;
        } else {
            var factorsList = (grade === 1) ? config.get(&#x27;wrongFactors&#x27;) : config.get(&#x27;rightFactors&#x27;);
            var divisions = [2, 1200, 18000, 691200];
            var index;
            for (var i in divisions)
            {
                if (item.get(&#x27;interval&#x27;) &gt; divisions[i]) {
                    index = i;
                }
            }
            factor = factorsList[index];
        }
        //adjust the factor based on readiness
        if (grade &gt; 2) {
            factor -= 1;
            factor *= actualInterval / scheduledInterval;
            factor += 1;
        }
        //accelerate new items that appear to be known
        if (item.get(&#x27;successes&#x27;) === item.get(&#x27;reviews&#x27;) &amp;&amp; item.get(&#x27;reviews&#x27;) &lt; 5) {
            factor *= 1.5;
        }
        //decelerate hard items consistently marked wrong
        if (item.get(&#x27;reviews&#x27;) &gt; 8) {
            if (pctRight &lt; 0.5)
                factor *= Math.pow(pctRight, 0.7);
        }
        //multiple by the factor and randomize the interval
        newInterval = getRandomizedInterval(item.get(&#x27;interval&#x27;) * factor);
        //bound the interval
        if (grade === 1) {
            if (newInterval &gt; 604800) {
                newInterval = 604800;
            } else if (newInterval &lt; 30) {
                newInterval = 30;
            }
        } else {
            if (newInterval &gt; 315569260) {
                newInterval = 315569260;
            } else if (grade === 2 &amp;&amp; newInterval &lt; 300) {
                newInterval = 300;
            } else if (newInterval &lt; 30) {
                newInterval = 30;
            }
        }
        return newInterval;
    };

    /**
     * @method getNext
     * @param {Function} callback
     */
    Scheduler.prototype.getNext = function(callback) {
        var items = this.sort();
        var position = 0;
        next();
        function next() {
            var item = items[position];
            skritter.data.items.loadItems(item, false, function() {
                item = skritter.data.items.findWhere({id: item.id});
                if (item.checkIntegrity()) {
                    callback(item);
                } else {
                    position++;
                    next();
                }
            });
        }
    };

    /**
     * @method loadFromDatabase
     * @param {Function} callback
     */
    Scheduler.prototype.loadFromDatabase = function(callback) {
        skritter.storage.getSchedule(function(schedule) {
            skritter.scheduler.schedule = schedule;
            skritter.scheduler.filter();
            callback();
        });
    };

    /**
     * @method sort
     * @param {Boolean} deprioritizeLongShots
     * @returns {Array}
     */
    Scheduler.prototype.sort = function(deprioritizeLongShots) {
        var self = this;
        deprioritizeLongShots = deprioritizeLongShots ? deprioritizeLongShots : false;
        var now = skritter.fn.getUnixTime();
        this.schedule = _.sortBy(this.schedule, function(item) {
            var historicItem = _.find(self.history, {base: item.base});
            if (!historicItem || (now - historicItem.last) &gt;= 300) {
                if (!item.last &amp;&amp; (item.next - now) &gt; 600) {
                    item.readiness = 0.2;
                    return -item.readiness;
                }
                if (!item.last || (item.next - item.last) === 1) {
                    item.readiness = 90019001;
                    return -item.readiness;
                }
            }
            var seenAgo = now - item.last;
            var rtd = item.next - item.last;
            var readiness = seenAgo / rtd;
            if (readiness &gt; 0 &amp;&amp; seenAgo &gt; 9000) {
                var dayBonus = 1;
                var ageBonus = 0.1 * Math.log(dayBonus + (dayBonus * dayBonus * seenAgo) * (1 / 86400));
                var readiness2 = (readiness &gt; 1) ? 0.0 : 1 - readiness;
                ageBonus *= readiness2 * readiness2;
                readiness += ageBonus;
            }
            if (deprioritizeLongShots) {
                var lengthPenalty;
                if (readiness &gt; 2.5 &amp;&amp; rtd &gt; 600) {
                    if (readiness &gt; 20) {
                        readiness = 1.5;
                    } else {
                        readiness = 3.5 - Math.pow(readiness * 0.4, 0.33333);
                    }
                }
                if (lengthPenalty &amp;&amp; readiness &gt; 1)
                    readiness = Math.pow(readiness, 1 + lengthPenalty);
            }
            item.readiness = readiness;
            return -item.readiness;
        });
        console.log(&#x27;READINESS ORDER&#x27;);
        var top = this.schedule.slice(0, 9);
        for (var i in top)
                console.log(top[i].readiness, top[i].id);
        return this.schedule;
    };
    
    /**
     * @method updateItem
     * @param {Backbone.Model} item
     */
    Scheduler.prototype.updateItem = function(item) {
        var id = item.get(&#x27;id&#x27;);
        var splitId = id.split(&#x27;-&#x27;);
        var scheduleItem = {
            base: splitId[1] + &#x27;-&#x27; + splitId[2] + &#x27;-&#x27; + splitId[3],
            id: id,
            last: item.get(&#x27;last&#x27;),
            next: item.get(&#x27;next&#x27;),
            part: item.get(&#x27;part&#x27;),
            style: item.get(&#x27;style&#x27;),
            vocabIds: item.get(&#x27;vocabIds&#x27;)
        };
        this.schedule[_.findIndex(this.schedule, {id: id})] = scheduleItem;
        var historicIndex = _.findIndex(this.history, {base: scheduleItem.base});
        if (historicIndex &gt; -1) {
            this.history[historicIndex] = scheduleItem;
        } else {
            this.history.push(scheduleItem);
        }
    };

    return Scheduler;
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
